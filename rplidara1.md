# **Setting Up and Running RPLidar A1 in WSL Ubuntu 18.04**

This guide provides a step-by-step process to set up and run the RPLidar A1 in WSL (Windows Subsystem for Linux) Ubuntu 18.04. It includes all necessary commands and explanations to guide beginners.

---

## **1. Install ROS Eloquent**

Follow the official instructions to install ROS Eloquent:  
https://docs.ros.org/en/eloquent/Installation.html  

Commands to ensure ROS is installed properly:
```bash
# Check if ROS is installed
echo $ROS_DISTRO

# Confirm Eloquent is the active distribution
ls /opt/ros/
```

If `eloquent` is not listed, install ROS Eloquent from the link above.

---

## **2. Install RPLidar ROS Package**

Clone and build the RPLidar ROS package:
```bash
# Create a workspace
mkdir -p ~/ws_lidar/src
cd ~/ws_lidar/src

# Clone RPLidar ROS package
git clone https://github.com/Slamtec/rplidar_ros.git

# Build the workspace
cd ~/ws_lidar
source /opt/ros/eloquent/setup.bash
colcon build

# Source the workspace
source ~/ws_lidar/install/setup.bash
```

---

## **3. Connect and Configure RPLidar**

Ensure your RPLidar is connected and recognized:
```bash
# List all USB devices
ls /dev | grep tty

# Check permissions for the device (replace ttyUSB0 with your device)
ls -l /dev/ttyUSB0

# Add permissions if necessary
sudo chmod 666 /dev/ttyUSB0
```

---

## **4. Launch RPLidar Node**

Run the RPLidar ROS node:
```bash
# Launch the RPLidar node
ros2 launch rplidar_ros rplidar.launch.py
```

If successful, you should see output indicating that the RPLidar node is running.

---

## **5. Visualize Data in RViz**

Launch RViz to visualize the laser scans:
```bash
# Open RViz
rviz2
```

Configure RViz:
- **Fixed Frame**: Set to `laser`.
- **Add Displays**: Add `LaserScan` and set the topic to `/scan`.

---

## **6. Install and Configure SLAM Toolbox**

Install SLAM Toolbox for mapping:
```bash
# Install SLAM Toolbox
sudo apt install ros-eloquent-slam-toolbox
```

Launch SLAM Toolbox:
```bash
# Online synchronous SLAM
ros2 launch slam_toolbox online_sync_launch.py

# OR online asynchronous SLAM
ros2 launch slam_toolbox online_async_launch.py
```

---

## **7. Visualize Mapping in RViz**

To visualize the map generated by SLAM Toolbox:
- Add the **Map** display in RViz.
- Set the **Fixed Frame** to `map`.

---

## **8. Debugging and Transform Visualization**

### **Check Active Nodes**
To ensure SLAM Toolbox and other nodes are running:
```bash
ros2 node list
```

Expected output:
```
/slam_toolbox
/transform_listener_impl_XXXXX
/other_nodes
```

### **Check TF Frames**
To visualize transform frames:
```bash
# Install TF2 Tools
mkdir -p ~/ws_tf2_tools/src
cd ~/ws_tf2_tools/src
git clone https://github.com/ros2/geometry2.git

# Build the workspace
cd ~/ws_tf2_tools
colcon build

# Source the workspace
source ~/ws_tf2_tools/install/setup.bash

# Generate TF frame graph
python3 ~/ws_tf2_tools/install/tf2_tools/lib/tf2_tools/view_frames.py
```

Check the generated `frames.pdf` for TF data:
```bash
xdg-open frames.pdf
```

---

## **9. Miscellaneous Debugging Commands**

### **View LaserScan Data**
```bash
ros2 topic echo /scan
```

### **View TF Transforms**
```bash
ros2 topic echo /tf
ros2 topic echo /tf_static
```

---

## **10. Troubleshooting**

- **No Data in RViz**:
  - Ensure the `LaserScan` topic matches `/scan`.
  - Verify the RPLidar is connected and permissions are set.

- **SLAM Map Not Updating**:
  - Confirm that `map` and `odom` transforms are published (`/tf` topic).

- **No TF Frames in PDF**:
  - Check if TF data is being broadcast using `ros2 topic echo /tf`.

---
If `/dev/ttyUSB0` does not exist, it means your RPLidar is not connected or not being detected by the system. Here’s how you can troubleshoot and resolve the issue:

---

## **1. Check Device Connection**
Make sure the RPLidar is properly connected to your computer.

### **Check USB Devices**
```bash
lsusb
```
This will list all connected USB devices. Look for a device that corresponds to RPLidar (often labeled with `Slamtec` or similar).

---

## **2. Reload USB Port**
Sometimes, reloading the USB drivers can help detect the device:
```bash
sudo dmesg | grep tty
```
This will show logs related to connected devices. If you see something like `ttyUSB0` or `ttyUSB1`, note the port name.

If no relevant logs appear, try reconnecting the USB cable or connecting it to a different port.

---

## **3. Install USB-Serial Drivers**
If you’re using a USB-to-serial converter, install the drivers:
```bash
sudo apt update
sudo apt install usbutils
sudo apt install setserial
```

For some devices (like CP210x or CH340 chip-based converters), you may need to load specific kernel modules:
```bash
sudo modprobe cp210x
sudo modprobe ch341
```

---

## **4. Check Device Permissions**
Once you identify the correct port (`/dev/ttyUSB0` or `/dev/ttyUSB1`), set permissions:
```bash
ls -l /dev/ttyUSB*
sudo chmod 666 /dev/ttyUSB0
```

---

## **5. Verify Again**
Run the following command again to confirm the device is detected:
```bash
ls /dev | grep ttyUSB
```

---

## **6. If the Issue Persists**
- Try the RPLidar on a different machine to ensure the hardware is working.
- Ensure WSL is configured to pass USB devices to the Linux environment. If WSL doesn’t support USB directly, you might need to use a tool like **USBIP** to connect the USB device from Windows to WSL.

```bash
# Install USBIP in WSL
sudo apt install usbip
```

Follow [this guide](https://learn.microsoft.com/en-us/windows/wsl/connect-usb) for USB redirection in WSL.

---
Below is a comprehensive guide in Markdown format that includes all commands, potential errors, and solutions to set up the RPLIDAR A1 in WSL on Windows. This guide assumes the use of ROS 2 Eloquent and includes solutions for the issues you faced.

---

# RPLIDAR A1 Setup on WSL Ubuntu 18.04 with ROS 2 Eloquent

This guide provides step-by-step instructions for setting up and troubleshooting RPLIDAR A1 in WSL Ubuntu 18.04 using ROS 2 Eloquent.

## Prerequisites

1. **Install ROS 2 Eloquent**  
   Follow the official installation guide: [ROS 2 Eloquent Installation](https://docs.ros.org/en/eloquent/Installation.html).

2. **Install USBIPD for WSL**  
   Ensure that `usbipd-win` is installed on Windows:
   ```powershell
   winget install dorssel.usbipd-win
   ```

3. **Add RPLIDAR USB Device to WSL**  
   - Check the USBIPD version:
     ```powershell
     usbipd --version
     ```
   - List available USB devices:
     ```powershell
     usbipd list
     ```
   - Bind the device to WSL:
     ```powershell
     usbipd bind --busid <BUSID>
     ```
   - Attach the device to your WSL instance:
     ```powershell
     usbipd attach --busid <BUSID> --wsl Ubuntu-18.04
     ```

## ROS 2 Workspace Setup

### 1. Create a New Workspace
```bash
mkdir -p ~/ws_lidar/src
cd ~/ws_lidar
colcon build
source install/setup.bash
```

### 2. Clone RPLIDAR ROS Package
```bash
cd ~/ws_lidar/src
git clone https://github.com/robopeak/rplidar_ros.git
```

### 3. Fix Launch File Syntax for ROS 2 Eloquent
Replace all `executable=` with `node_executable=`:
```bash
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/executable=/node_executable=/g' {} +
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/node_node_executable/node_executable/g' {} +
```

### 4. Build the Workspace
```bash
cd ~/ws_lidar
colcon build --symlink-install
source install/setup.bash
```

### 5. Add Workspace Sourcing to `.bashrc`
```bash
echo "source /opt/ros/eloquent/setup.bash" >> ~/.bashrc
echo "source ~/ws_lidar/install/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

## Connect RPLIDAR to WSL

1. **Verify the Device is Connected**
   ```bash
   lsusb
   ```
   Look for a device like `Cygnal Integrated Products, Inc. CP210x UART Bridge`.

2. **Set Device Permissions**
   ```bash
   sudo chmod 777 /dev/ttyUSB0
   ```

3. **Test Serial Port Connection**
   ```bash
   dmesg | grep ttyUSB
   ```

## Launch RPLIDAR ROS Node

### 1. Test the Launch File
Run the appropriate launch file for your RPLIDAR model:
```bash
ros2 launch rplidar_ros view_rplidar_a1_launch.py
```

### 2. Visualize Data in Rviz
Ensure that the `rviz2` node is launched alongside the RPLIDAR node. If not, manually start `rviz2`:
```bash
rviz2
```
Add a `LaserScan` display in Rviz and select the `/scan` topic.

## Common Issues and Fixes

### 1. Missing `node_executable` Error
Update the launch files as described above:
```bash
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/executable=/node_executable=/g' {} +
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/node_node_executable/node_executable/g' {} +
```

### 2. `/dev/ttyUSB0` Not Found
Check device logs:
```bash
dmesg | grep ttyUSB
```
If no output, ensure the USB device is attached to WSL and permissions are set.

### 3. `rplidar_node` Missing
Rebuild the workspace:
```bash
cd ~/ws_lidar
rm -rf build install log
colcon build --symlink-install
source install/setup.bash
```

### 4. USB Device Not Accessible in WSL
Ensure `usbipd` is configured correctly. Re-attach the device:
```powershell
usbipd attach --busid <BUSID> --wsl Ubuntu-18.04
```

---

## Commands Summary

Here’s a quick summary of all important commands:

### Workspace and ROS Environment Setup
```bash
mkdir -p ~/ws_lidar/src
cd ~/ws_lidar
colcon build
source install/setup.bash
echo "source /opt/ros/eloquent/setup.bash" >> ~/.bashrc
echo "source ~/ws_lidar/install/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### Clone and Build RPLIDAR ROS Package
```bash
cd ~/ws_lidar/src
git clone https://github.com/robopeak/rplidar_ros.git
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/executable=/node_executable=/g' {} +
find ~/ws_lidar/src/rplidar_ros/launch -type f -name "*.py" -exec sed -i 's/node_node_executable/node_executable/g' {} +
cd ~/ws_lidar
colcon build --symlink-install
```

### USBIPD Setup on Windows
```powershell
usbipd bind --busid <BUSID>
usbipd attach --busid <BUSID> --wsl Ubuntu-18.04
```

### Serial Device Setup in WSL
```bash
lsusb
sudo chmod 777 /dev/ttyUSB0
dmesg | grep ttyUSB
```

### Launch RPLIDAR Node
```bash
ros2 launch rplidar_ros view_rplidar_a1_launch.py
```

---

Let me know if you need further clarifications or additions!
